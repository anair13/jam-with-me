<p id="notice"><%= notice %></p>

<script type="text/javascript">


var context = new AudioContext();
var firebase_song_identifier = "https://jamwithme.firebaseio.com/music/<%= @song.firebase_identifier %>";
var firebase_chat_identifier = "https://jamwithme.firebaseio.com/chat/<%= @song.firebase_identifier %>";
var firebase_userlist_identifier = "https://jamwithme.firebaseio.com/users/<%= @song.firebase_identifier %>";
window.onload = init;
var bufferLoader;

var buffers = new Array();
var notes = new Array();
var notemap = new Array();
var noteRefs = new Array();
var endTime;
var playbackStartTime = context.currentTime + 0.100;
var tempo = 80; // BPM (beats per minute)
var atomNoteTime = (60 / tempo) / 8; // 32nd note

var MINUTES = 20;
var d = new Date();
var startTime = d.getTime();
var thissession = new Firebase('https://jamwithme.firebaseio.com/music/thissession');
thissession.on('value', function(snapshot) {
  var session = snapshot.val();
  var ID = session.ID;
  endTime = session.endTime;

  setInterval(function() {
    var thisDate = new Date();
    $('#box_header').text(get_elapsed_time_string(Math.floor((endTime - thisDate.getTime())/1000)));
  }, 1000);
  var temp = d.getTime()
  setTimeout(function() {
    killSession();
  }, endTime - startTime);
});

var myDataRef = new Firebase(firebase_song_identifier);

function editNote(step, length, type, position) {
  var n = d.getTime();
  if(n > endTime) {
    killSession();
  }
  
  if(length == '0') {
    noteRefs[notemap.indexOf([step,type,position].toString())].remove();
    console.log(notemap);
    console.log(noteRefs);
  }
  else {
    noteRefs.unshift(myDataRef.push());
    console.log("noteRefs: ",noteRefs);
    noteRefs[0].set({step: step, length: length, type:type, position: position});
    notemap.unshift([step, type, position].toString());
    console.log("notemap: ",notemap);
    $('#position').val('');
  }
}

myDataRef.on('child_added', function(snapshot) {
  var message = snapshot.val();
  playNote(message.step, message.length, message.type, message.position);
});

function displayChatMessage(step, length) {
  $('<div/>').text(step).prepend($('<em/>').text(length+': ')).appendTo($('#messagesDiv'));
  $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
};

function killSession() {
  var n = d.getTime();
  var endTime = n + MINUTES * 60 * 1000;
  thissession.set({ID: n, endTime: endTime});
  location.reload(true);
}

function get_elapsed_time_string(total_seconds) {
    function pretty_time_string(num) {
      return ( num < 10 ? "0" : "" ) + num;
    }

    var hours = Math.floor(total_seconds / 3600);
    total_seconds = total_seconds % 3600;

    var minutes = Math.floor(total_seconds / 60);
    total_seconds = total_seconds % 60;

    var seconds = Math.floor(total_seconds);

    // Pad the minutes and seconds with leading zeros, if required
    hours = pretty_time_string(hours);
    minutes = pretty_time_string(minutes);
    seconds = pretty_time_string(seconds);

    // Compose the string for display
    var currentTimeString = hours + ":" + minutes + ":" + seconds;

    return currentTimeString;
}

function init() {
  // Fix up prefixing
  Controller.Init();
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  context = new AudioContext();

  bufferLoader = new BufferLoader(
    context,
    [
      "../assets/pianoc4.wav",
      "../assets/violinc5.wav",
//    "http://localhost:3000/assets/guitarc4.wav"
    ],
    finishedLoading
    );

  bufferLoader.load();
}

function finishedLoading(bufferList) {
  buffers = bufferList;
}

function playNote(step, length, type, position) {
    // convert type of instrument to corresponding bufferIndex
    bufferIndex = 0;
    switch (type) {
        case "piano":
            bufferIndex = 1;
        case "violin":
            bufferIndex = 2;
        default:
            bufferIndex = 0;
    }
    var timeOn = playbackStartTime + position * atomNoteTime;
    var timeOff = timeOn + length * atomNoteTime;
    var source = getTone(step, bufferIndex);
    source.start(timeOn);
    source.noteOff(timeOff);
}

// Generates a source from a buffer and shifts it to the right tone
function getTone(semitones, bufferIndex) {
  var source = context.createBufferSource();
  source.buffer = buffers[bufferIndex];
  source.connect(context.destination);
  var semitoneRatio = Math.pow(2, 1/12);
  source.playbackRate.value = Math.pow(semitoneRatio, semitones);
  if (!source.start)
    source.start = source.noteOn;
  return source;
}

// var rec = new Recorder(context.destination, {workerPath: "/assets/recorderWorker.js"});

function playback() {
  rec.record();
  playbackStartTime = context.currentTime + 0.100;
  var myDataRef = new Firebase(firebase_song_identifier);
  myDataRef.on('child_added', function(snapshot) {
    var message = snapshot.val();
    playNote(message.step, message.length, message.type, message.position);
  });
}

var chatDataRef = new Firebase(firebase_chat_identifier);
$('#message').keypress(function (e) {
    if (e.keyCode == 13) {
      var name = username;
      var text = $('#message').val();
      chatDataRef.push({name: name, text: text});
      $('#message').val('');
       
    }
});
chatDataRef.on('child_added', function(snapshot) {
  var message = snapshot.val();
  displayChatMessage(message.name, message.text);
});
function displayChatMessage(name, text) {
  $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
  $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
};
// function stopRecording() {
//     rec.stop();
//     createDownloadLink();
    
//     rec.clear();
//   }

// function createDownloadLink() {
//     rec && recorder.exportWAV(function(blob) {
//       var url = URL.createObjectURL(blob);
//       var li = document.createElement('li');
//       var au = document.createElement('audio');
//       var hf = document.createElement('a');
      
//       au.controls = true;
//       au.src = url;
//       hf.href = url;
//       hf.download = new Date().toISOString() + '.wav';
//       hf.innerHTML = hf.download;
//       li.appendChild(au);
//       li.appendChild(hf);
//       recordingslist.appendChild(li);
//     });
// }

</script>
<div class="container">
  <div class="main-container no-margins">
    <div id="track-container">
      <canvas class="drawing-canvas" id="drawCanvas"></canvas>
      <canvas class="drawing-canvas" id="drawCanvas2"></canvas>
    </div>
    <div class="settings-container">
      <div style="float: left; width: 40%">
        <b>Snap To:</b><br>
        <input type="radio" name="settings_snap" value="4" checked="checked">Quarter Notes<br>
        <input type="radio" name="settings_snap" value="8">Eighth Notes<br>
        <input type="radio" name="settings_snap" value="16">16th Notes<br>
        <input type="radio" name="settings_snap" value="32">32nd Notes<br>
      </div>
      <div style="float: left; width: 40%">
        <b>Note Type:</b><br>
        <input type="radio" name="settings_length" value="1">Whole Notes<br>
        <input type="radio" name="settings_length" value="2">Half Notes<br>
        <input type="radio" name="settings_length" value="4" checked="checked">Quarter Notes<br>
        <input type="radio" name="settings_length" value="8">Eighth Notes<br>
        <input type="radio" name="settings_length" value="16">16th Notes<br>
        <input type="radio" name="settings_length" value="32">32nd Notes<br>
      </div>
      <div>
        <b>Action:</b><br>
        <input type="radio" name="settings_action" value="add" checked="checked">Add Note<br>
        <input type="radio" name="settings_action" value="remove">Remove Note<br>
      </div>
    </div>
  </div>
  <div class="chat-container no-margins">
    <div id = "messagesDiv" class="chat-buffer-container no-margins">
      <p>Buffer</p>
    </div>
    <div class="chat-type-container no-margins">
      <input type="text" id = "message" value="Type Here" />
    </div>
  </div>
</div>
<!-- Inconsequential image dump referenced by JS -->
<img class="invisible" id="note_whole" src="../assets/notes/whole.png" />
<img class="invisible" id="note_half" src="../assets/notes/half.png" />
<img class="invisible" id="note_quarter" src="../assets/notes/quarter.png" />
<img class="invisible" id="note_eighth" src="../assets/notes/eighth.png" />
<img class="invisible" id="note_sixteenth" src="../assets/notes/sixteenth.png" />
<img class="invisible" id="note_thirtysecond" src="../assets/notes/thirtysecond.png" />
<img class="invisible" id="instrument_piano" src="http://placehold.it/50x50" />
<img class="invisible" id="instrument_drums" src="http://placehold.it/50x50" />
<img class="invisible" id="instrument_violin" src="http://placehold.it/50x50" />
<img class="invisible" id="instrument_synth" src="http://placehold.it/50x50" />
<img class="invisible" id="clef_treble" src="../assets/clefs/treble_clef.gif" />
<img class="invisible" id="clef_bass" src="../assets/clefs/bass_clef.png" />
<img id="ghost_note" class="invisible no-margins" src="../assets/notes/piano_note_1.gif" />
